name: legate-boost build/test

concurrency:
  group: ci-on-${{ github.event_name }}-from-${{ github.ref_name }}
  cancel-in-progress: true

on:
  push:
    branches:
      - "pull-request/[0-9]+"
      - "branch-*"
      - "main"
jobs:

  # group together all jobs that must pass for a PR to be merged
  # # (for use by branch protections)
  # pr-builder:
  #   if: github.ref != 'refs/heads/main'
  #   needs:
  #     - pre-commit
  #     - conda-python-build
  #     - conda-python-tests-cpu
  #     - conda-python-tests-gpu
  #     - 

  pre-commit:
    runs-on: ubuntu-latest
    steps:
    - name: short-circuit
      run: exit 0
    # - uses: actions/checkout@v4
    # - uses: pre-commit/action@v3.0.1

  conda-python-build:
    needs: [pre-commit]
    strategy:
      fail-fast: false
      # As of the last time this was updated, legate-core / cunumeric packages were published for only:
      #
      #  * architectures: amd64 only#
      #  * CUDA: >=12.2
      #  * Python: 3.10, 3.11, 3.12
      #
      # Valid set of RAPIDS ci-conda image tags: # valid CI image tags: https://hub.docker.com/r/rapidsai/ci-conda/tags
      matrix:
        ARCH:
          - "amd64"
        CUDA_VER:
          - "12.5.1"
        PY_VER:
          - "3.10"
          - "3.11"
          - "3.12"
    uses: rapidsai/shared-workflows/.github/workflows/custom-job.yaml@branch-24.10
    secrets: inherit
    with:
      arch: ${{ matrix.ARCH }}
      build_type: pull-request
      container_image: "rapidsai/ci-conda:cuda${{ matrix.CUDA_VER }}-ubuntu22.04-py${{ matrix.PY_VER }}"
      node_type: "cpu4"
      run_script: ci/build_python.sh

  conda-python-tests-cpu:
    needs: [conda-python-build]
    strategy:
      fail-fast: false
      # valid CI image tags: https://hub.docker.com/r/rapidsai/ci-conda/tags
      matrix:
        include:
          - ARCH: "amd64"
            PY_VER: "3.11"
            CUDA_VER: "12.5.1"
    uses: rapidsai/shared-workflows/.github/workflows/custom-job.yaml@branch-24.10
    with:
      arch: ${{ matrix.ARCH }}
      build_type: pull-request
      container_image: "rapidsai/ci-conda:cuda${{ matrix.CUDA_VER }}-ubuntu22.04-py${{ matrix.PY_VER }}"
      # use a runner that does not have a GPU
      node_type: "cpu16"
      run_script: ci/test_python_cpu.sh

  conda-python-tests-gpu:
    needs: [conda-python-build]
    strategy:
      fail-fast: false
      # valid CI image tags: https://hub.docker.com/r/rapidsai/ci-conda/tags
      matrix:
        include:
          - ARCH: "amd64"
            PY_VER: "3.10"
            CUDA_VER: "12.5.1"
    uses: rapidsai/shared-workflows/.github/workflows/custom-job.yaml@branch-24.10
    with:
      arch: ${{ matrix.ARCH }}
      build_type: pull-request
      container_image: "rapidsai/ci-conda:cuda${{ matrix.CUDA_VER }}-ubuntu22.04-py${{ matrix.PY_VER }}"
      node_type: "gpu-v100-latest-1"
      run_script: ci/test_python_gpu.sh

  # build-test:
  #   needs: [pre-commit, conda-python-build]
  #   defaults:
  #     run:
  #       shell: bash -el {0}
  #   runs-on: linux-amd64-gpu-v100-latest-1
  #   env:
  #     CONDA_PREFIX: /opt/conda
  #   container:
  #     image: rapidsai/devcontainers:24.08-cpp-cuda11.8-mambaforge-ubuntu22.04
  #     env:
  #       NVIDIA_VISIBLE_DEVICES: ${{ env.NVIDIA_VISIBLE_DEVICES }} # GPU jobs must set this container env variable
  #   steps:
  #     - name: Checkout legate-boost
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Install legate/cunumeric
  #       run: |
  #         mamba install --yes -c rapidsai \
  #           'rapids-dependency-file-generator>=1.14.0'

  #         rapids-dependency-file-generator \
  #           --output conda \
  #           --file-key all \
  #           --matrix "cuda=${CUDA_VERSION};arch=$(arch)" | tee /tmp/env.yaml

  #         # update the current environment (instead of creating a new one), as that
  #         # persists across all steps
  #         mamba env update \
  #           --name base \
  #           --file /tmp/env.yaml
      # - name: Build legate-boost
      #   env:
      #     CUDAARCHS: '70;80'
      #   run: |
      #     ci/build_wheel.sh
      # - uses: actions/upload-artifact@v4
      #   with:
      #     name: legateboost-wheel
      #     path: dist/legate_boost*.whl
      #     if-no-files-found: error
      # - name: Install legate-boost
      #   run: |
      #     python -m pip install --no-deps dist/*.whl
      # - name: Run cpu tests
      #   run: |
      #     exit 0
      #     # legate --sysmem 28000 --module pytest legateboost/test/[!_]**.py -sv --durations=0
      # - name: Run gpu tests
      #   run: |
      #     nvidia-smi
      #     exit 0
      #     # legate --gpus 1 --fbmem 28000 --sysmem 28000 --module pytest legateboost/test/[!_]**.py -sv --durations=0 -k 'not sklearn'
      # - name: Build legate-boost docs
      #   working-directory: docs
      #   run: |
      #     make html
      # - uses: actions/upload-pages-artifact@v3
      #   with:
      #     path: docs/build/html

  deploy:
    needs:
      - conda-python-build
      - conda-python-tests-cpu
      - conda-python-tests-gpu
      # - build-test
    # only main branch uploads docs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source

    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    # Specify runner + deployment step
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
